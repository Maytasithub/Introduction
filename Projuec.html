<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Projuec</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }

    canvas { display: block; }

    #popupOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      z-index: 10;
    }

    #popupImage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      max-width: 80%;
      max-height: 80%;
      border: 2px solid white;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      z-index: 11;
    }

    #popupText {
      position: absolute;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 24px;
      z-index: 12;
      display: none;
      text-shadow: 0 0 5px black;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/EXRLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body>

  <div id="popupOverlay"></div>
  <img id="popupImage" src="" alt="Popup" />
  <div id="popupText"></div>

  <script>
    (() => {
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(60, innerWidth / innerHeight, 0.1, 100);
      camera.position.set(0, 1.2, 4);

      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(innerWidth, innerHeight);
      document.body.appendChild(renderer.domElement);

      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.target.set(0, 0.5, 0);
      controls.enableDamping = true;

      const clickable = [];

      const gltfLoader = new THREE.GLTFLoader();

      // ðŸŒ³ à¹‚à¸¡à¹€à¸”à¸¥à¸—à¸µà¹ˆ 1: Maple Tree
      gltfLoader.load('./toon_tree_02.glb',
        function (gltf) {
          const model = gltf.scene;
          model.position.set(0.9, -0.2, -2);
          model.scale.set(5, 5, 5);
          model.userData = {
            image: './maple_image.jpg',
            name: 'à¸•à¹‰à¸™à¹€à¸¡à¹€à¸›à¸´à¹‰à¸¥ (Maple Tree)'
          };
          scene.add(model);
          clickable.push(model);
        },
        undefined,
        function (error) {
          console.error('GLB load error:', error);
        }
      );

      // ðŸ§ à¹‚à¸¡à¹€à¸”à¸¥à¸—à¸µà¹ˆ 2: MyName
      gltfLoader.load('./myname.glb',
        function (gltf) {
          const model = gltf.scene;
          model.position.set(1, 0, 2);
          model.scale.set(1, 1, 1);
          model.userData = {
            image: './myname_image.jpg',
            name: 'à¸Šà¸·à¹ˆà¸­à¸‚à¸­à¸‡à¸‰à¸±à¸™ (My Name)'
          };
          scene.add(model);
          clickable.push(model);
        },
        undefined,
        function (error) {
          console.error('GLB load error:', error);
        }
      );

      // ðŸŒŒ EXR à¸žà¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡
      const exrLoader = new THREE.EXRLoader();
      exrLoader.load('./narrow_moonlit_road_4k.exr', function (texture) {
        texture.mapping = THREE.EquirectangularReflectionMapping;
        scene.background = texture;
        scene.environment = texture;
      });

      // ðŸ’¡ à¹€à¸žà¸´à¹ˆà¸¡à¹à¸ªà¸‡à¹ƒà¸«à¹‰à¸”à¸¹à¸”à¸µà¸‚à¸¶à¹‰à¸™
      const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
      hemiLight.position.set(0, 20, 0);
      scene.add(hemiLight);

      const dirLight = new THREE.DirectionalLight(0xffffff, 1);
      dirLight.position.set(3, 10, 5);
      scene.add(dirLight);

      const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
      scene.add(ambientLight);

      // ðŸ” Raycaster à¸ªà¸³à¸«à¸£à¸±à¸šà¸„à¸¥à¸´à¸
      const raycaster = new THREE.Raycaster();
      const mouse = new THREE.Vector2();

      window.addEventListener('click', (event) => {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(clickable, true);

        if (intersects.length > 0) {
          const object = intersects[0].object;
          const rootModel = getRootModel(object);
          if (rootModel.userData) {
            showPopupImage(rootModel.userData.image, rootModel.userData.name);
          }
        }
      });

      function getRootModel(obj) {
        while (obj.parent && !clickable.includes(obj)) {
          obj = obj.parent;
        }
        return obj;
      }

      function loop() {
        controls.update();
        renderer.render(scene, camera);
        requestAnimationFrame(loop);
      }
      loop();
    })();
  </script>
</body>
</html>
